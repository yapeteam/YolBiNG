package cn.yapeteam.yolbi.module.impl.exploit;

import cn.yapeteam.yolbi.event.Listener;
import cn.yapeteam.yolbi.event.impl.player.UpdateEvent;
import cn.yapeteam.yolbi.event.impl.render.RenderEvent;
import cn.yapeteam.yolbi.module.Module;
import cn.yapeteam.yolbi.module.ModuleCategory;
import cn.yapeteam.yolbi.module.ModuleInfo;
import cn.yapeteam.yolbi.util.network.PacketUtil;
import cn.yapeteam.yolbi.util.player.InventoryUtil;
import net.minecraft.client.gui.ScaledResolution;
import net.minecraft.network.play.client.C03PacketPlayer;
import net.minecraft.network.play.client.C07PacketPlayerDigging;
import net.minecraft.network.play.client.C0BPacketEntityAction;
import net.minecraft.util.BlockPos;
import net.minecraft.util.EnumFacing;

/**
 * @author yuxiangll
 * @package cn.yapeteam.yolbi.module.impl.exploit
 * don't mind
 * @date 2023/8/26 21:43
 */
@ModuleInfo(name = "BowBomb", category = ModuleCategory.EXPLOIT)
public class BowBomb extends Module {
    private boolean flag = false;
    private long sum = 0;

    protected void onEnableStart() {
        int bowslot = InventoryUtil.getBowAtHotbar();
        if (bowslot != -1) {
            mc.thePlayer.inventory.currentItem = bowslot;
            PacketUtil.sendPacketNoEvent(new C0BPacketEntityAction(mc.thePlayer, C0BPacketEntityAction.Action.START_SPRINTING));
        } else {
            this.setEnabled(false);
        }
    }

    @Override
    protected void onDisable() {
        flag = false;
        sum = 0;
        mc.gameSettings.keyBindUseItem.setPressed(false);
        mc.thePlayer.stopUsingItem();
        PacketUtil.sendPacketNoEvent(new C07PacketPlayerDigging(C07PacketPlayerDigging.Action.RELEASE_USE_ITEM, BlockPos.ORIGIN, EnumFacing.DOWN));

    }


    @Listener
    public void onUpdate(UpdateEvent event) {
        if (mc.gameSettings.keyBindUseItem.isKeyDown()) {
            if (flag == false) {
                flag = true;
                onEnableStart();
            }
            sum++;
            PacketUtil.sendPacketNoEvent(new C03PacketPlayer.C04PacketPlayerPosition(mc.thePlayer.posX, mc.thePlayer.posY - 1e-10, mc.thePlayer.posZ, true));
            PacketUtil.sendPacketNoEvent(new C03PacketPlayer.C04PacketPlayerPosition(mc.thePlayer.posX, mc.thePlayer.posY + 1e-10, mc.thePlayer.posZ, false));
        } else if (flag == true) {
            this.setEnabled(false);
        }
    }

    @Listener
    protected void onRender(RenderEvent event) {
        if (mc.gameSettings.keyBindUseItem.isKeyDown()) {
            ScaledResolution res = new ScaledResolution(mc);

            mc.fontRendererObj.drawString(String.valueOf(sum), res.getScaledWidth() / 2 - 3, res.getScaledHeight() / 2 + 5, -1);
        }

    }
}
